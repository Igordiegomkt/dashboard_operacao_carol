<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>📊 Dashboard Operação de Tráfego Carol - 2</title>

  <!-- Supabase + Tailwind + Chart.js -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color:#0f172a; color:#f1f5f9; font-family:'Inter',sans-serif; }
    .card { background:rgba(255,255,255,0.05); border-radius:1rem; padding:1.5rem; transition:.3s; }
    .card:hover { transform:scale(1.01); box-shadow:0 0 25px rgba(56,189,248,.1); }
    .title { font-size:1.4rem; font-weight:700; margin-bottom:.5rem; color:#f8fafc; }
    .number { font-size:2.5rem; font-weight:800; color:#38bdf8; }
    table { width:100%; margin-top:1rem; border-collapse:collapse; }
    th,td { padding:.6rem; border-bottom:1px solid rgba(255,255,255,.1); text-align:left; }
    th { color:#94a3b8; font-weight:600; }
    tr:hover { background-color:rgba(255,255,255,.04); }
    button { background:#38bdf8; color:#0f172a; padding:.5rem 1rem; border-radius:.4rem; font-weight:600; font-size:.9rem; }
    button:hover { background:#0ea5e9; }
    .header { display:flex; flex-direction:column; align-items:center; gap:.3rem; margin-bottom:1rem; text-align:center; }
    .clock { font-size:1rem; color:#38bdf8; font-weight:600; }

    /* Filtro minimalista */
    .filter-icon {
      position:fixed; top:1rem; right:1rem; width:38px; height:38px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(56,189,248,.15); color:#38bdf8; border:1px solid rgba(56,189,248,.4);
      border-radius:50%; cursor:pointer; backdrop-filter:blur(6px);
      box-shadow:0 0 10px rgba(56,189,248,.1); transition:.3s; z-index:1000;
    }
    .filter-icon:hover { background:rgba(56,189,248,.3); }
    .filter-popup {
      position:fixed; top:4rem; right:1rem; width:220px; display:none; flex-direction:column; gap:.4rem;
      background:rgba(15,23,42,.95); border:1px solid rgba(56,189,248,.3); border-radius:.75rem;
      padding:.8rem 1rem; color:#f1f5f9; font-size:.85rem; backdrop-filter:blur(10px);
      box-shadow:0 0 15px rgba(56,189,248,.15); z-index:999; animation:fadeIn .2s ease;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
    .filter-popup label { font-size:.75rem; color:#94a3b8; }
    .filter-popup input,.filter-popup select {
      background:#1e293b; border:1px solid #334155; border-radius:.4rem; padding:.3rem .5rem; color:#f1f5f9; font-size:.8rem; width:100%;
    }
    .filter-popup button { margin-top:.2rem; font-size:.75rem; font-weight:600; padding:.3rem; border-radius:.4rem; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-6">
  <div class="header">
    <h1 class="text-3xl font-extrabold text-cyan-400">🚦 Dashboard Operação de Tráfego Carol - 2</h1>
    <p class="clock" id="clock">🕒 Carregando hora...</p>
  </div>

  <!-- Filtro -->
  <div class="filter-icon" id="filterToggle" title="Filtrar 🔍">🔍</div>
  <div class="filter-popup" id="filterPopup">
    <label>📅 Data</label>
    <input type="text" id="filterDate" placeholder="dd/mm/aaaa" />
    <label>👤 Operador</label>
    <select id="filterOperador">
      <option value="Todos">Todos</option>
      <option value="IGOR">IGOR</option>
      <option value="JULIO">JULIO</option>
    </select>
    <button id="applyFilter" style="background:#38bdf8;color:#0f172a;">Filtrar</button>
    <button id="clearFilter" style="background:#475569;color:white;">Limpar</button>
  </div>

  <!-- Cards -->
  <div class="grid grid-cols-3 gap-6 mb-10 w-full max-w-5xl mt-8">
    <div class="card text-center"><div class="title">Operador IGOR</div><div id="countIgor" class="number">0</div></div>
    <div class="card text-center"><div class="title">Operador JULIO</div><div id="countJulio" class="number text-green-400">0</div></div>
    <div class="card text-center"><div class="title">🔥 Total</div><div id="countTotal" class="number text-yellow-400">0</div></div>
  </div>

  <!-- Gráficos -->
  <div class="w-full max-w-6xl grid grid-cols-2 gap-8 mb-12">
    <div class="card"><div class="title">📈 Origem (utm_source)</div><canvas id="chartSource"></canvas></div>
    <div class="card"><div class="title">📣 Campanhas (utm_campaign)</div><canvas id="chartCampaign"></canvas></div>
    <div class="card"><div class="title">🎨 Criativos (utm_content)</div><canvas id="chartContent"></canvas></div>
    <div class="card"><div class="title">📱 Terminais (utm_term)</div><canvas id="chartTerm"></canvas></div>
  </div>

  <!-- Tabela -->
  <div class="card w-full max-w-6xl overflow-x-auto mb-10">
    <div class="flex justify-between items-center mb-4">
      <div class="title">📥 Últimos Leads</div>
      <button id="toggleLeads">Mostrar mais</button>
    </div>
    <table id="leadsTable">
      <thead>
        <tr>
          <th>Operador</th><th>Caminho</th><th>Data</th><th>Hora</th>
          <th>utm_source</th><th>utm_campaign</th><th>utm_content</th><th>utm_term</th><th>fbclid</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <p class="text-slate-500 text-sm mt-6">© Operação Carol — Realtime Dashboard</p>

  <script>
    // Relógio (SP)
    setInterval(() => {
      const opt = { timeZone:'America/Sao_Paulo', hour:'2-digit', minute:'2-digit', second:'2-digit' };
      document.getElementById('clock').textContent = '🕒 ' + new Intl.DateTimeFormat('pt-BR', opt).format(new Date());
    }, 1000);

    // Supabase client
    const supabase = window.supabase.createClient(
      "https://atexvoxukvaqittpqkov.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0ZXh2b3h1a3ZhcWl0dHBxa292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NTYyNjAsImV4cCI6MjA3NjEzMjI2MH0.HptK9KRkqkSQL3jrwAwH0rOSDGhlXOTwGwGqjwNgtU4"
    );

    const tableBody = document.getElementById("tableBody");
    const countIgor = document.getElementById("countIgor");
    const countJulio = document.getElementById("countJulio");
    const countTotal = document.getElementById("countTotal");
    const toggleLeads = document.getElementById("toggleLeads");
    const filterPopup = document.getElementById("filterPopup");
    const filterToggle = document.getElementById("filterToggle");
    const filterDate = document.getElementById("filterDate");
    const filterOperador = document.getElementById("filterOperador");
    const applyFilter = document.getElementById("applyFilter");
    const clearFilter = document.getElementById("clearFilter");

    let allData = [], showingAll = false, charts = {};
    let currentFilter = { date: null, operador: "Todos" };
    const seenIds = new Set();

    filterToggle.addEventListener("click", () => {
      filterPopup.style.display = (filterPopup.style.display === "flex" ? "none" : "flex");
    });

    async function getCountFromDB({ date, operador = null }) {
      let q = supabase.from("PRESSEL_DADOS_TRAFEGO_PJTCAROL").select("*", { count: "exact", head: true });
      const targetDate = date || new Date().toLocaleDateString("pt-BR");
      q = q.eq("data", targetDate);
      if (operador) q = q.eq("operador", operador);
      const { count } = await q;
      return count || 0;
    }

    async function updateCounts() {
      const date = currentFilter?.date || null;
      const [igor, julio, total] = await Promise.all([
        getCountFromDB({ date, operador: "IGOR" }),
        getCountFromDB({ date, operador: "JULIO" }),
        getCountFromDB({ date })
      ]);
      countIgor.textContent = igor;
      countJulio.textContent = julio;
      countTotal.textContent = total;
    }

    async function loadData(dateFilter = null, operador = "Todos") {
      let query = supabase.from("PRESSEL_DADOS_TRAFEGO_PJTCAROL").select("*");
      const targetDate = dateFilter || new Date().toLocaleDateString("pt-BR");
      query = query.eq("data", targetDate);
      if (operador !== "Todos") query = query.eq("operador", operador);

      const { data, error } = await query.order("id", { ascending: false }).limit(200);
      if (error) { console.error(error); return; }

      allData = data || [];
      currentFilter = { date: dateFilter || null, operador };
      renderTable();
      updateCharts();
      await updateCounts();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      (showingAll ? allData : allData.slice(0, 10)).forEach(l => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${l.operador}</td><td>${l.caminho}</td><td>${l.data}</td><td>${l.hora}</td>
          <td>${l.utm_source || "-"}</td><td>${l.utm_campaign || "-"}</td>
          <td>${l.utm_content || "-"}</td><td>${l.utm_term || "-"}</td>
          <td>${l.fbclid ? l.fbclid.substring(0, 10) + "..." : "-"}</td>`;
        tableBody.appendChild(tr);
      });
    }

    function groupCount(key) {
      const map = {};
      allData.forEach(l => {
        const k = (l[key] && l[key] !== "Indefinido" && l[key].trim() !== "") ? l[key] : null;
        if (k) map[k] = (map[k] || 0) + 1;
      });
      return { labels:Object.keys(map), values:Object.values(map) };
    }

    function updateCharts() {
      const sets = {
        chartSource: groupCount("utm_source"),
        chartCampaign: groupCount("utm_campaign"),
        chartContent: groupCount("utm_content"),
        chartTerm: groupCount("utm_term")
      };
      Object.entries(sets).forEach(([id, d]) => {
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
          type:"bar",
          data:{ labels:d.labels, datasets:[{ data:d.values, backgroundColor:"#38bdf8", hoverBackgroundColor:"#7dd3fc" }] },
          options:{ responsive:true, indexAxis:"y", plugins:{ legend:{ display:false } } }
        });
      });
    }

    toggleLeads.addEventListener("click", () => {
      showingAll = !showingAll;
      toggleLeads.textContent = showingAll ? "Mostrar menos" : "Mostrar mais";
      renderTable();
    });

    applyFilter.addEventListener("click", () => {
      loadData(filterDate.value.trim() || null, filterOperador.value);
      filterPopup.style.display = "none";
    });

    clearFilter.addEventListener("click", () => {
      filterDate.value = ""; filterOperador.value = "Todos";
      loadData(); filterPopup.style.display = "none";
    });

    // Realtime
    supabase
      .channel("realtime:leads")
      .on("postgres_changes", { event:"INSERT", schema:"public", table:"PRESSEL_DADOS_TRAFEGO_PJTCAROL" }, async payload => {
        const l = payload.new;
        const matchDate = !currentFilter.date || l.data === currentFilter.date;
        const matchOp = currentFilter.operador === "Todos" || l.operador === currentFilter.operador;
        if (!matchDate || !matchOp) return;

        const key = l.id ?? `${l.operador}-${l.data}-${l.hora}-${l.fbclid||''}`;
        if (seenIds.has(key)) return;
        seenIds.add(key);
        allData.unshift(l);
        renderTable();
        updateCharts();
        await updateCounts();
      })
      .subscribe();

    // 🕛 Reset automático à meia-noite (fuso São Paulo)
    let lastDate = new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo' })
      .format(new Date());
    setInterval(() => {
      const nowDate = new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo' })
        .format(new Date());
      if (nowDate !== lastDate) {
        console.log("⏰ Virada de dia detectada! Resetando dashboard...");
        lastDate = nowDate;
        allData = [];
        tableBody.innerHTML = "";
        Object.values(charts).forEach(ch => ch.destroy());
        charts = {};
        loadData(); // recarrega com data nova
      }
    }, 60 * 1000);

    loadData();
  </script>
</body>
</html>
